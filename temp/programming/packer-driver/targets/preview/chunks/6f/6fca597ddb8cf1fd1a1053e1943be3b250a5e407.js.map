{"version":3,"sources":["file:///D:/File/Cocos/ECS_Demo/assets/src/GameStart.ts"],"names":["_decorator","Component","Input","input","instantiate","KeyCode","Label","Prefab","Square","EventCenter","GameMessageC2S_Operation","GameMessageType","MessagePool","WSClient","ccclass","property","GameStart","_keyMap","Map","_squares","uid","isInGame","onClickGameStart","onLoad","on","EventType","KEY_DOWN","keyDown","KEY_UP","keyUp","instance","S2C_GAME_START","toString","onGetGameStart","S2C_OPERATIONS","onGetOperations","S2C_UID","onGetUID","start","set","KEY_A","KEY_S","KEY_D","KEY_W","connect","update","deltaTime","x","y","get","msg","body","dir","send","recycle","event","has","keyCode","uids","forEach","index","addPlayer","operations","operation","square","move","lbUserID","string","squarePrefab","getComponent","node","parent"],"mappings":"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","sourcesContent":["import { _decorator, Component, EventKeyboard, Input, input, instantiate, KeyCode, Label, Prefab } from 'cc';\r\nimport { Vector3 } from './Config';\r\nimport { Square } from './Square';\r\nimport { EventCenter } from './EventCenter';\r\nimport { GameMessageC2S_Operation, GameMessageOperationBody, GameMessageS2C_GameStart, GameMessageS2C_Operations, GameMessageS2C_UID, GameMessageType, MessagePool } from './GameMessageBase';\r\nimport { WSClient } from './WSClient';\r\nconst { ccclass, property } = _decorator;\r\n\r\n@ccclass('GameStart')\r\nexport class GameStart extends Component {\r\n\r\n    @property(Prefab)\r\n    squarePrefab: Prefab = null;\r\n\r\n    @property(Label)\r\n    lbUserID: Label = null;\r\n\r\n    private _keyMap: Map<KeyCode, boolean> = new Map();\r\n\r\n    private _squares: Map<number, Square> = new Map();\r\n\r\n    uid: number = 0;\r\n\r\n    isInGame: boolean = false;\r\n\r\n    onClickGameStart() {\r\n\r\n    }\r\n\r\n    protected onLoad(): void {\r\n        input.on(Input.EventType.KEY_DOWN, this.keyDown, this);\r\n        input.on(Input.EventType.KEY_UP, this.keyUp, this);\r\n\r\n        EventCenter.instance.on(GameMessageType.S2C_GAME_START.toString(), this.onGetGameStart, this);\r\n        EventCenter.instance.on(GameMessageType.S2C_OPERATIONS.toString(), this.onGetOperations, this);\r\n        EventCenter.instance.on(GameMessageType.S2C_UID.toString(), this.onGetUID, this);\r\n    }\r\n\r\n    protected start() {\r\n        this._keyMap.set(KeyCode.KEY_A, false);\r\n        this._keyMap.set(KeyCode.KEY_S, false);\r\n        this._keyMap.set(KeyCode.KEY_D, false);\r\n        this._keyMap.set(KeyCode.KEY_W, false);\r\n\r\n        WSClient.instance.connect();\r\n    }\r\n\r\n    protected update(deltaTime: number) {\r\n\r\n        let x = 0;\r\n        let y = 0;\r\n\r\n        if (this._keyMap.get(KeyCode.KEY_A))\r\n            x -= 1;\r\n\r\n        if (this._keyMap.get(KeyCode.KEY_S))\r\n            y -= 1;\r\n\r\n        if (this._keyMap.get(KeyCode.KEY_D))\r\n            x += 1;\r\n\r\n        if (this._keyMap.get(KeyCode.KEY_W))\r\n            y += 1;\r\n\r\n        if (x === 0 && y === 0) {\r\n            return;\r\n        }\r\n\r\n        let msg = MessagePool.get(GameMessageC2S_Operation);\r\n        msg.uid = this.uid;\r\n        msg.body.dir.set(x, y);\r\n\r\n        WSClient.instance.send(msg);\r\n\r\n        MessagePool.recycle(msg);\r\n    }\r\n\r\n    private keyDown(event: EventKeyboard): void {\r\n        if (this._keyMap.has(event.keyCode)) {\r\n            this._keyMap.set(event.keyCode, true);\r\n        }\r\n    }\r\n\r\n    private keyUp(event: EventKeyboard): void {\r\n        if (this._keyMap.has(event.keyCode)) {\r\n            this._keyMap.set(event.keyCode, false);\r\n        }\r\n    }\r\n\r\n    private onGetGameStart(msg: GameMessageS2C_GameStart) {\r\n        msg.uids.forEach((uid, index) => {\r\n            this.addPlayer(uid);\r\n        });\r\n    }\r\n\r\n    private onGetOperations(msg: GameMessageS2C_Operations) {\r\n        msg.operations.forEach((operation, index) => {\r\n            let square = this._squares.get(operation.uid);\r\n            square.move(operation.body.dir);\r\n        });\r\n    }\r\n\r\n    private onGetUID(msg: GameMessageS2C_UID) {\r\n        this.uid = msg.uid;\r\n        this.lbUserID.string = this.uid.toString();\r\n    }\r\n\r\n    private addPlayer(uid: number) {\r\n        let square = instantiate(this.squarePrefab).getComponent(Square);\r\n        square.node.parent = this.node;\r\n        this._squares.set(uid, square);\r\n    }\r\n}\r\n\r\n\r\n"]}